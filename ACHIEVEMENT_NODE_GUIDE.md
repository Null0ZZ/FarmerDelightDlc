# 成就节点编辑功能说明

## 功能概述

成就节点编辑器允许你为每个模组创建一个树形或网络结构的成就系统，每个节点可以关联一个物品，并支持多父节点、多子节点的关系设定。

## 使用流程

### 1. 进入编辑模式

在模组卡片顶部，你会看到两个按钮：
- **📂 分类** - 物品分类模式（默认）
- **⭐ 编辑节点** - 成就节点编辑模式

点击 **编辑节点** 按钮进入成就节点编辑页面。

### 2. 创建节点

在右侧控制面板中，点击 **➕ 创建根节点** 按钮创建新节点。

- 每个新节点会自动分配一个唯一 ID
- 节点默认名称为 "节点 N"（N 为序号）
- 节点会在画布上自动排列

### 3. 选中节点

在画布上点击任意节点，该节点会高亮显示并在右侧面板显示可用操作：
- 节点内显示关联的物品图标（如果已关联）
- 选中状态下节点会显示绿色边框

### 4. 设置节点物品

点击右侧面板中的 **📦 设置物品** 按钮：
- 弹出模组物品列表
- 选择一个物品关联到此节点
- 物品的纹理将显示在节点上
- 按钮会显示 ✓ 标记表示已关联

### 5. 编辑节点描述

点击右侧面板中的 **📝 设置描述** 按钮：
- 弹出文本编辑框
- 输入节点的描述信息（如成就条件、奖励等）
- 描述会自动保存

### 6. 设置父节点关系

点击右侧面板中的 **🔗 设置父节点** 按钮：
- 显示所有可用的父节点列表
- 可选择多个父节点（一个节点可以有多个父节点）
- 系统会自动防止循环依赖
- 已关联的父节点会显示 ✓ 标记

**规则说明：**
- 一个节点可以有多个父节点
- 一个节点也可以被多个子节点引用
- 系统自动检测循环依赖，防止形成死循环
- 删除节点时，对该节点的所有引用也会被删除

### 7. 删除节点

点击右侧面板中的 **🗑️ 删除节点** 按钮：
- 系统会弹出确认对话框
- 确认后节点会被删除
- 所有指向该节点的父节点引用也会被清除

### 8. 查看连线

页面画布上会实时显示节点之间的连线：
- **绿色曲线** - 表示节点之间的父子关系
- **箭头方向** - 箭头指向父节点，表示从子节点指向父节点
- 连线会自动根据节点位置更新

### 9. 保存更改

完成所有编辑后，点击右侧面板底部的 **✅ 保存更改** 按钮：
- 所有节点信息和关系会被保存到模组数据中
- 页面会显示 "成就节点已更新" 的提示

### 10. 返回分类

点击左上角的 **← 返回分类** 按钮返回物品分类模式。

## 数据结构

### AchievementNode 节点对象

```typescript
{
  id: string;                      // 节点唯一标识
  name: string;                    // 节点名称
  itemId?: string;                 // 关联的物品 ID（可选）
  description?: string;            // 节点描述（可选）
  parentNodeIds: string[];         // 父节点 ID 列表
  position?: {                     // 节点在画布上的位置
    x: number;
    y: number;
  };
}
```

### AchievementGraph 成就图结构

```typescript
{
  modId: string;                   // 关联的模组 ID
  nodes: AchievementNode[];        // 所有节点
}
```

## 导出和导入

成就节点数据会被保存在模组的 `achievementGraph` 字段中。

### 导出 JSON 示例

```json
{
  "mods": [
    {
      "id": "mod-id",
      "name": "模组名称",
      ...
      "achievementGraph": {
        "modId": "mod-id",
        "nodes": [
          {
            "id": "node-1",
            "name": "开始",
            "itemId": "item-1",
            "description": "第一个成就",
            "parentNodeIds": [],
            "position": { "x": 100, "y": 100 }
          },
          {
            "id": "node-2",
            "name": "进阶",
            "itemId": "item-2",
            "description": "第二个成就",
            "parentNodeIds": ["node-1"],
            "position": { "x": 250, "y": 100 }
          }
        ]
      }
    }
  ]
}
```

## 技术特点

- ✅ **实时连线绘制** - 使用 Canvas 绘制节点间的贝塞尔曲线连接
- ✅ **循环检测** - 自动防止形成循环依赖的父子关系
- ✅ **多父节点支持** - 支持一对多、多对多的节点关系
- ✅ **自动排列** - 新创建的节点自动在画布上排列
- ✅ **实时更新** - 所有操作实时反映在画布上
- ✅ **数据持久化** - 支持导出/导入完整的节点配置

## 常见问题

**Q: 如何移动节点位置？**  
A: 目前节点位置由系统自动分配。后续可扩展拖动功能。

**Q: 能否删除已关联物品的节点？**  
A: 可以。删除节点时，关联的物品信息会被移除，但物品本身不会被删除。

**Q: 循环依赖会发生什么？**  
A: 系统会自动检测并阻止设置会形成循环的父节点关系，页面会弹出警告提示。

**Q: 节点数据如何保存？**  
A: 所有节点数据保存在模组的 `achievementGraph` 字段中，导出 JSON 时会包含完整的节点信息。
